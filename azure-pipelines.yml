trigger:
  branches:
    include:
      - main

variables:
- name: buildConfiguration
  value: 'Release'

stages:
- stage: Build_And_Deploy
  jobs:
  - job: BuildDeployJob
    pool:
      name: 'SelfHostedAgent'
      demands:
        - agent.name -equals RCTSA-35VOLR3

    steps:
    # 1️⃣ Use .NET 10 SDK
    - task: UseDotNet@2
      displayName: 'Use .NET 10 SDK'
      inputs:
        packageType: 'sdk'
        version: '10.0.x'
        includePreviewVersions: true
        installationPath: $(Agent.ToolsDirectory)/dotnet

    # 2️⃣ Restore NuGet packages
    - task: DotNetCoreCLI@2
      displayName: 'Restore NuGet Packages'
      inputs:
        command: 'restore'
        projects: '**/*.csproj'

    # 3️⃣ Build the solution
    - task: DotNetCoreCLI@2
      displayName: 'Build Solution'
      inputs:
        command: 'build'
        projects: '**/*.csproj'
        arguments: '--configuration $(buildConfiguration)'

    # 4️⃣ Publish the project
    - task: DotNetCoreCLI@2
      displayName: 'Publish Project'
      inputs:
        command: 'publish'
        publishWebProjects: true
        arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'
        zipAfterPublish: false

    # 5️⃣ Stop IIS Website
    - task: PowerShell@2
      displayName: 'Stop IIS Website'
      inputs:
        targetType: 'inline'
        script: |
          Import-Module WebAdministration
          Stop-Website -Name "WebCrud"

    # 6️⃣ Copy Published Files to IIS Folder (contents only)
    - task: PowerShell@2
      displayName: 'Deploy to IIS Folder'
      inputs:
        targetType: 'inline'
        script: |
          $source = "$(Build.ArtifactStagingDirectory)"
          $destination = "C:\Publish IIS localhost rp\WebCrud"

          Write-Host "Source: $source"
          Write-Host "Destination: $destination"

          # Ensure destination exists
          if (!(Test-Path $destination)) {
              New-Item -ItemType Directory -Path $destination -Force | Out-Null
          }

          # Remove old files
          Remove-Item "$destination\*" -Recurse -Force -ErrorAction SilentlyContinue

          # Copy **contents only**, not the folder itself
          Get-ChildItem "$source" -Recurse | ForEach-Object {
              $dest = Join-Path $destination ($_.FullName.Substring($source.Length + 1))
              if ($_.PSIsContainer) {
                  if (!(Test-Path $dest)) { New-Item -ItemType Directory -Path $dest -Force | Out-Null }
              } else {
                  Copy-Item $_.FullName $dest -Force
              }
          }

    # 7️⃣ Start IIS Website
    - task: PowerShell@2
      displayName: 'Start IIS Website'
      inputs:
        targetType: 'inline'
        script: |
          Import-Module WebAdministration
          Start-Website -Name "WebCrud"